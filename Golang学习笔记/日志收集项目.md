# 日志收集项目

## 消息队列

> 把同步的函数调用函数，改成异步化
>
> 实现进程间的通信

### 通信模式

- 点对点模式：消息生产者生产消息发送到`queue`，消息消费者从`queue`中取出并消费消费。一条消息被消费后，`queue`中就没了，不存在重复消费
- 发布/订阅模式：生产者将消息发布到`topic`中，同时有多个消费者订阅消费该消息（发布到`topic`的消息会被所有订阅者消费）（可以看成是一个`topic`下有多个`queue`，每个`queue`是点对点，`queue`之间是发布订阅模式）

### Kafka介绍

> Kafka之所以比较快，是每条消息都有唯一标识offset，把物理磁盘的随机读改成了顺序读，效率很高

#### 框架

![image-20210419142950782](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419142950782.png)

#### 组件介绍

![image-20210419143047317](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419143047317.png)

![image-20210419144624233](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419144624233.png)



#### 工作流程

> prodecer是生产者，是数据的入口，会把数据写入到`leader`中，不会直接写到`follower`中

![image-20210419143421653](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419143421653.png)

#### 获取partition的原则

![image-20210419143704956](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419143704956.png)

#### ACK应答机制

![image-20210419144004109](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419144004109.png)

#### topic详解

- ![image-20210419145453271](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419145453271.png)

  ![image-20210419145503842](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419145503842.png)

#### Kafka的数据保存

![image-20210419150036617](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419150036617.png)

#### partition存储消息的原理

![image-20210419150141285](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419150141285.png)

#### 消费消息原理

![image-20210419150228586](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419150228586.png)

![image-20210419150556456](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419150556456.png)

### Kafka使用

- 修改配置

  - `zookeeper.properties`修改`dataDir=D:/tmp/zookeeper`
  - `server.properties`修改
    - `log.dirs=D:/tmp/kafka-logs`日志存放目录
    - `num.partitions=1`分区数量
    - `zookeeper.connect=localhost:2181`zookeeper连接的地址
    - 。。。

- 想要运行kafka需先运行ZooKeeper服务器

  ```powershell
  D:\kafka_2.13-2.7.0>bin\windows\zookeeper-server-start.bat config\zookeeper.properties
  ```

  - 报错`系统找不到指定的路径。`，需要修改`kafka-run-class.bat`的java环境变量

  - `zookeeper`在kafka中的作用，Go中逐渐被`etcd`代替

    > Kafka集群的节点启动后，注册到zookeeper，用户连接Kafka集群的节点时，也是从zookeeper查询
    >
    > ![image-20210419162110089](D:\资料\Go\src\studygo\Golang学习笔记\日志收集项目.assets\image-20210419162110089.png)

    1. Broker注册
    2. Topic注册
    3. 生产者负载均衡 / 消费者负载均衡
    4. 分区与消费者的关系
    5. 消费进度Offset记录
    6. 消费者注册

- 启动kafka

  ```powershell
  D:\kafka_2.13-2.7.0>bin\windows\kafka-server-start.bat config\server.properties
  ```

## 项目模块

### LogAgent

#### 工作流程

1. 读日志`tailf`第三方库
2. 往kafka写日志`sarama`第三方库